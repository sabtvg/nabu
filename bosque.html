<!--
///////////////////////////////////////////////////////////////////////////
//  Copyright 2015 - 2020 Sabrina Prestigiacomo nabu@nabu.pt
//
//  This program is free software: you can redistribute it and/or modify
//  it under the terms of the GNU General Public License as published by
//  the Free Software Foundation, either version 3 of the License, or
//  any later version.
//  
//  This program is distributed in the hope that it will be useful,
//  but WITHOUT ANY WARRANTY; without even the implied warranty of
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//  GNU General Public License for more details.
//  
//  You should have received a copy of the GNU General Public License
//  along with this program.  If not, see <http://www.gnu.org/licenses/>.
//  
///////////////////////////////////////////////////////////////////////////
-->


<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
    <title>Nab&uacute</title>
    <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
    <META HTTP-EQUIV="EXPIRES" CONTENT="Mon, 22 Jul 2002 11:12:01 GMT">
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no">
    <script src="js/util.js"></script>
    <script src="js/dictionary.js"></script>
    <script src="js/tween.min.js"></script>
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/three.min.js"></script>
    <script src="js/tween.min.js"></script>
    <script src="js/OrbitControls.js"></script>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="styles.css">
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
    <script>
        var usuario;
        var offsetX = -10000;
        var offsetY = -10000;
        var zoom = 1;
        var bosque;
        var scale = window.innerWidth / 1920;
        var grupoParam;
        var arbolPersonal;
        var grupos;
        var usuarios = "";
        var representantes = "";
        var lastMouse = null;
        var generando = false;
        var torsionInterval;
        var firefoxWhich = 0;
        var altura = 200;
        var imgW = 17 * zoom; //imagen personita
        var imgH = 42 * zoom; //imagen personita
        var email = ""; //usuario seleccionado
        var ver = "grupos"; //tipo de representacion
        var margen = 16;
        var cleanInterval;

        //webgl
        var gl; // Un variable global para el contexto WebGL
        var camera;
        var renderer;
        var scene;
        var controls;
        var cache = [];
        var selected;

        $(document).mouseup(function (event) {
            //document.getElementById("joystick").innerHTML = "mouseup.event.which: " + event.which;
            firefoxWhich = 0;
        });

        $(document).mousedown(function (event) {
            //document.getElementById("joystick").innerHTML = "mousedown.event.which: " + event.which;
            firefoxWhich = 1;
            //detecto objeto 
            if (ver == "3D") {
                event.preventDefault();
                var raycaster = new THREE.Raycaster()
                var mouse = new THREE.Vector2();
                var objects = [];
                mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
                mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                var intersects = raycaster.intersectObjects(scene.children);
                if (intersects.length > 0) {
                    selected = intersects[0].object;
                    if (selected.name != "plano") {
                        //obtengo tamaño del objeto seleccionado
                        var bounds = new THREE.Box3();
                        bounds.setFromObject(selected);
                        var sizex = bounds.max.x - bounds.min.x;
                        var sizey = bounds.max.y - bounds.min.y;

                        //apunto la camara
                        //lookAt
                        var tween = new TWEEN.Tween(controls.target)
                            .to(selected.position, 1000)
                            .easing(TWEEN.Easing.Cubic.Out)
                            .onUpdate(function () {
                                camera.lookAt(this.x, this.y, this.z);
                            })
                            .start();
                        //position
                        var finalPosition = selected.position.clone();
                        finalPosition.z += sizex * 4;
                        finalPosition.y += sizey * 2;
                        var tween = new TWEEN.Tween(camera.position)
                            .to(finalPosition, 1000)
                            .easing(TWEEN.Easing.Cubic.Out)
                            .onUpdate(function () {
                                camera.position.set(this.x, this.y, this.z);
                            })
                            .start();
                    }
                }
                else
                    selected = null;
            }
        });

        $(document).mousemove(function (event) {
            move(event);
            event.preventDefault();
        });

        function transform(offsetX, offsetY) {
            var g = document.getElementById("grupo");
            if (g) {
                var matrix0 = document.getElementById("todo").createSVGMatrix();
                matrix0 = matrix0.translate(offsetX, offsetY);
                if (g.transform.baseVal.numberOfItems == 0)
                    g.transform.baseVal.appendItem(g.transform.baseVal.createSVGTransformFromMatrix(matrix0));
                else
                    g.transform.baseVal.getItem(0).setMatrix(matrix0);
            }
        }

        function move(event) {
            if (firefoxWhich == 1 && !event.ctrlKey) {
                //scroll
                if (lastMouse) {
                    if (ver == '3D') {
                        //event.preventDefault();
                        //camera.position.x += lastMouse.clientY - event.clientY;
                        //camera.position.y += lastMouse.clientX - event.clientX;
                    }
                    else {
                        offsetX -= lastMouse.clientX - event.clientX;
                        offsetY -= lastMouse.clientY - event.clientY;
                        transform(offsetX, offsetY);
                    }
                }
                lastMouse = { clientX: event.clientX, clientY: event.clientY };
            }
            else if (firefoxWhich == 1 && event.ctrlKey) {
                //zoom
                if (lastMouse) {
                    zoom += (lastMouse.clientX - event.clientX) * 2 / window.innerWidth;
                    //document.body.style.cursor = "w-resize";
                    dibujarTodo();
                }
                lastMouse = { clientX: event.clientX, clientY: event.clientY };
            }
            else {
                lastMouse = null;
            }
            //$("div").text(event.which + ", " + event.ctrlKey);        
        }

        function doLoad() {
            //cargo recursos
            loadImg('res/3D/inactivo.png');
            loadImg('res/3D/readonly.png');
            loadImg('res/3D/secretaria.png');
            loadImg('res/3D/facilitador.png');
            loadImg('res/3D/representante.png');
            loadImg('res/3D/activo.png');
            loadImg('res/3D/coordinador.png');
            loadImg('res/3D/accion.png');
            loadImg('res/3D/evento.png');
            loadImg('res/3D/manifiesto.png');
            loadImg('res/3D/noticias.png');
            loadImg('res/3D/debates.png');
            loadFont('fonts/helvetiker_regular.typeface.json.txt');

            //espero carga de recursos
            load2();
        }

        function load2() {
            if (cache.length < 13)
                setTimeout(load2, 300);
            else {
                //background
                setBackgroundImage();

                //eventos tactiles
                document.body.addEventListener('touchmove', function (e) {
                    var touch = e.changedTouches[0] // reference first touch point for this event
                    firefoxWhich = 1;
                    touch.ctrlKey = false;
                    move(touch);
                }, false)

                document.body.addEventListener('touchend', function (e) {
                    lastMouse = null;
                }, false)

                //idioma
                idioma = getParameterByName('idioma');
                if (idioma == null) idioma = 'es';

                //obtengo datos de los parametros
                grupoParam = getParameterByName('grupo');
                if (grupoParam && grupoParam != "" && grupoParam != "null") {
                    //leo cookie
                    var cookie = getCookie("nabu-" + grupoParam);
                    if (cookie == "")
                        //login normal
                        document.location = 'default.html?grupo=' + grupoParam;
                    else {
                        var scalex = window.innerWidth / 1920;
                        var scaley = window.innerHeight / 1080;

                        //cargo datos iniciales
                        var vals = cookie.split("|");
                        usuario = { nombre: vals[0], email: vals[1], clave: vals[2], grupo: vals[3], isAdmin: vals[4], idioma: vals[5] };

                        idioma = vals[5]; //para el tradcutor

                        if (!usuario) {
                            //login normal
                            document.location = 'default.html?grupo=' + grupoParam;
                        }
                        else {
                            document.getElementById("titulo").innerHTML = usuario.grupo + " - " + tr("El bosque");
                            actualizarBosque();
                            torsionInterval = setInterval(doTorsion, 100);
                        }
                    }
                }
                else
                    //login normal
                    document.location = 'default.html?grupo=' + grupoParam;
            }
        }

        function actualizarBosque() {
            getBosque("getBosque");
        }

        function generarBosque() {
            getBosque("clearBosque");
        }

        function getBosque(accion) {
            email = "";

            var div = document.getElementById("info");
            div.style.visibility = "hidden";

            getHttp("doMain.aspx?actn=" + accion + "&email=" + usuario.email
                + "&grupo=" + usuario.grupo
                + "&clave=" + usuario.clave,
                 function (data) {
                     //atrapo el error si es que hay
                     if (data.substring(0, 6) == "Error=") {
                         //ha habido un error
                         document.getElementById("msg").innerHTML = '<font color=red>' + data + '</font>';
                     }
                     else {
                         //tengo el bosque

                         bosque = JSON.parse(data);

                         dibujarTodo();
                     }
                 });
        }

        function dibujarTodo() {
            var scalex = window.innerWidth / 1920;
            var scaley = window.innerHeight / 1080;
            var s = "";

            generando = false;
            lastMouse = null;
            var dims = getDimensiones(bosque, 0);

            s += "<g id='grupo'>";
            //dibujo bosque
            if (ver == "grupos") {
                clean3D();
                s += doGrupos(window.innerWidth / 2 + 10000, window.innerHeight / 2 + 10000, window.innerWidth / 8 * zoom, doGrupoNodo);
            }
            else if (ver == "3D") {
                clean3D()
                s += do3D();
            }
            else {
                clean3D()
                s += doPersonas(window.innerWidth / 2 + 10000, window.innerHeight / 2 + 10000 - dims.alto / 2, doPersonasNodo);
            }
            s += "</g>"

            document.getElementById("todo").innerHTML = s;
            transform(offsetX, offsetY);

            //panelgrupo
            var usus = (usuarios.split(";").length - 1);
            var reps = (representantes.split(";").length - 1);
            s = "<div class='titulo3' style='margin: 0px;padding:0px;'><nobr>" + tr("Grupos") + ":" + grupos + "</nobr></div>";
            s += "<div class='titulo3' style='margin: 0px;padding:0px;'><nobr>" + tr("Usuarios") + ":" + usus + "</nobr></div>";
            if (ver != "grupos")
                s += "<div class='titulo3' style='margin: 0px;padding:0px;'><nobr>" + tr("Horizontalidad") + ":" + (reps / usus * 100).toFixed(0) + "%</nobr></div>";
            s += "<div class='menuItem' onclick='actualizarBosque();'><nobr>" + tr("Actualizar") + "</nobr></div>";
            s += "<div class='menuItem' onclick='generarBosque();'><nobr>" + tr("Generar") + "</nobr></div>";

            if (ver == "grupos") {
                s += "<div class='menuItem' onclick='ver=\"personas\";dibujarTodo();'><nobr>" + tr("Ver personas") + "</nobr></div>";
                if (webglAvailable()) s += "<div class='menuItem' onclick='ver=\"3D\";dibujarTodo();'><nobr>" + tr("Ver 3D") + "</nobr></div>";
                document.getElementById("info").style.visibility = 'hidden';
                email = "";
            }
            else if (ver == "3D") {
                s += "<div class='menuItem' onclick='ver=\"personas\";dibujarTodo();'><nobr>" + tr("Ver personas") + "</nobr></div>";
                s += "<div class='menuItem' onclick='ver=\"grupos\";dibujarTodo();'><nobr>" + tr("Ver grupos") + "</nobr></div>";
                document.getElementById("info").style.visibility = 'hidden';
                email = "";
            }
            else {
                s += "<div class='menuItem' onclick='ver=\"grupos\";dibujarTodo();'><nobr>" + tr("Ver grupos") + "</nobr></div>";
                if (webglAvailable()) s += "<div class='menuItem' onclick='ver=\"3D\";dibujarTodo();'><nobr>" + tr("Ver 3D") + "</nobr></div>";
            }
            var panel = document.getElementById("panelGrupo");
            panel.innerHTML = s;
            panel.style.visibility = 'visible';

            if (generando)
                setTimeout(actualizarBosque, 1000);
        }


        //3D
        function webglAvailable() {
            try {
                var canvas = document.createElement('canvas');
                return !!(window.WebGLRenderingContext && (canvas.getContext('webgl') || canvas.getContext('experimental-webgl'))
                );
            } catch (e) {
                return false;
            }
        }

        function iniciar3D() {
            renderer = new THREE.WebGLRenderer({ alpha: true, canvas: document.getElementById("canvasGL") });
            renderer.setSize(window.innerWidth - 30, window.innerHeight - 40);
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
            controls = new THREE.OrbitControls(camera);
            var fa = 150 * 0.025; //factor imagenes
            var sizex = 128 * fa;
            var sizey = 64 * fa;
            camera.position.z = sizex * 4;
            camera.position.y = sizey * 2;

            paint();

        }

        function clean3D(){
            //limpio escena
            if (renderer)
                while (scene.children.length > 0) 
                    scene.remove(scene.children[0]);
        }

        function do3D() {
            var scalex = window.innerWidth / 1920;
            var scaley = window.innerHeight / 1080;

            if (!renderer)
                iniciar3D();

            document.getElementById("todo").style.display = "none";
            document.getElementById("canvasGL").style.display = "inline";

            generando = false;

            //light
            var pointLight = new THREE.PointLight(0xFFFFFF);
            pointLight.position.x = 0;
            pointLight.position.y = 800;
            pointLight.position.z = 830;
            pointLight.lookAt(0, 0, 0);
            scene.add(pointLight);

            var AmbientLight = new THREE.AmbientLight(0x404040); // soft white light
            scene.add(AmbientLight);

            //panelgrupo
            s = "<div class='titulo3' style='margin: 0px;padding:0px;'><nobr>" + tr("Grupos") + ":" + 0 + "</nobr></div>";
            s += "<div class='titulo3' style='margin: 0px;padding:0px;'><nobr>" + tr("Usuarios") + ":" + 0 + "</nobr></div>";
            s += "<div class='titulo3' style='margin: 0px;padding:0px;'><nobr>" + tr("Horizontalidad") + ":" + 0 + "%</nobr></div>";
            s += "<div class='titulo3' style='margin: 0px;padding:0px;cursor:pointer;color:blue;text-decoration: underline;' onclick='actualizarBosque();'><nobr>" + tr("Actualizar") + "</nobr></div>";
            s += "<div class='titulo3' style='margin: 0px;padding:0px;cursor:pointer;color:blue;text-decoration: underline;' onclick='generarBosque();'><nobr>" + tr("Generar") + "</nobr></div>";
            var panel = document.getElementById("panelGrupo");
            panel.innerHTML = s;
            panel.style.visibility = 'visible';

            //plano
            //var geometry = new THREE.PlaneGeometry(3000, 3000);
            //var material = new THREE.MeshBasicMaterial({ color: 0xf0f0f0, side: THREE.DoubleSide, opacity: 0.5 });
            //var plane = new THREE.Mesh(geometry, material);
            //plane.rotation.x = 3.1415 / 2;
            //plane.position.y = -30;
            //scene.add(plane);

            //referencia
            //var lineMaterial = new THREE.LineBasicMaterial({ color: 0x101010, opacity: 1, linewidth: 23 });
            //var geometry = new THREE.Geometry();
            //geometry.vertices.push(new THREE.Vector3(0, 300, 0));
            //geometry.vertices.push(new THREE.Vector3(0, 0, 0));
            //geometry.vertices.push(new THREE.Vector3(300, 0, 0));
            //geometry.vertices.push(new THREE.Vector3(0, 0, 0));
            //geometry.vertices.push(new THREE.Vector3(0, 0, -300));
            //var referencia = new THREE.Line(geometry, lineMaterial);
            //scene.add(referencia);

            grupo3D(0, 0, 0, 150, bosque, 0, 0);

            if (generando)
                setTimeout(actualizarBosque, 1000);
        }

        function grupo3D(x, y, z, radio, nodo, nivel, direccion) {
            if (!nodo.descargado)
                generando = true;
            else {
                //nombre
                var fa = radio * 0.025; //factor imagenes
                var offy = radio * 1.9;
                if (offy < 50) offy = 50;
                var fsize = 50 * radio / 150;
                if (fsize < 35) fsize = 25;
                text(nodo.nombre, fsize * fa, x, y + offy, z);

                //usuarios
                var imgs = [];
                for (var i in nodo.usuarios) {
                    var usu = nodo.usuarios[i];
                    if (usu.isRepresentante)
                        imgs.push('res/3D/representante.png');
                    else if (usu.isAdmin)
                        imgs.push('res/3D/coordinador.png');
                    else if (usu.isSecretaria)
                        imgs.push('res/3D/secretaria.png');
                    else if (usu.isFacilitador)
                        imgs.push('res/3D/facilitador.png');
                    else if (!usu.isActive)
                        imgs.push('res/3D/inactivo.png');
                    else if (usu.readOnly)
                        imgs.push('res/3D/readonly.png');
                    else
                        imgs.push('res/3D/activo.png');
                }
                torus(x, y, z, radio, nodo.usuarios, 0, "blue", imgs, 16, 32, direccion);

                //seguimientos
                imgs = [];
                for (var i in nodo.seguimientos) {
                    imgs.push(nodo.seguimientos[i].icono.replace("/documentos/","/3D/"));
                }
                torus(x, y, z, radio * 2, nodo.seguimientos, 0, "red", imgs, 19, 18, direccion);

                //hijos
                torus(x, y, z, radio * 3, nodo.hijos, nivel, "green", null, 0, 0, direccion);
                var Cini = new THREE.Vector3(x, y, z);
                var Prot = new THREE.Vector3(0, 0, radio * 6);
                for (var q = 0; q < nodo.hijos.length; q++) {
                    if (nivel == 0) {
                        var paso = 360 / nodo.hijos.length;
                        Prot.y = 180 + paso * q;
                    }
                    else {
                        var paso = 180 / nodo.hijos.length;
                        Prot.y = direccion - paso * (nodo.hijos.length - 1) / 2 + paso * q;
                    }

                    var Chijo = VAdd(Cini, VPolToCar(Prot));
                    grupo3D(Chijo.x, Chijo.y, Chijo.z, radio * 0.4, nodo.hijos[q], nivel + 1, Prot.y);
                }

                //arbol central
                imgSize("res/3D/noticias.png", x, y - 64 * fa / 2, z, 128 * fa, 64 * fa);
                imgSize("res/3D/debates.png", x, y + 64 * fa / 2, z, 128 * fa, 64 * fa);

                //disco horizontal
                var geometry = new THREE.CircleGeometry(6 * radio, 32);
                var material = new THREE.LineBasicMaterial({ color: 0xffffff, transparent:true, opacity: 0.4, side: THREE.DoubleSide });
                var circle = new THREE.Mesh(geometry, material);
                circle.rotation.x = 3.14 / 2;
                circle.position.x = x;
                circle.position.y = y;
                circle.position.z = z;
                circle.name = "plano";
                scene.add(circle);
            }
        }

        function torus(x, y, z, radio, gajos, nivel, color, imgs, w, h, direccion) {
            //circle
            var lineMaterial = new THREE.LineDashedMaterial({ color: color, opacity: 1, linewidth: 1 });
            var geometry = new THREE.Geometry();
            var Pini = new THREE.Vector3(0, 0, radio)
            var Cimg;
            var imgIndex = 0;
            for (var g = 0; g < gajos.length; g++) {
                //incremento gajos
                if (nivel == 0) {
                    var paso = 360 / gajos.length;
                    Pini.y = 180 + paso * g;
                }
                else {
                    var paso = 180 / gajos.length;
                    Pini.y = direccion - paso * (gajos.length - 1) / 2 + paso * g;
                }

                //dibujo gajo
                var fa = radio * 0.0165; //factor imagenes
                var Prot = new THREE.Vector3(Pini.x, Pini.y, -radio)
                for (var q = 0; q < 360; q += 4) {
                    var Crot = VPolToCar(Prot);
                    var Cini = VPolToCar(Pini);
                    geometry.vertices.push(VAdd(Cini, Crot));
                    Prot.x += 4;
                    if (q == 180) {
                        //image (si hay)
                        if (imgs) {
                            var Cimg = VAdd(Cini, Crot); //centro para la imagen
                            if (imgIndex > imgs.length - 1) imgIndex = imgs.length - 1;
                            imgSize(imgs[imgIndex], x + Cimg.x, y + Cimg.y, z + Cimg.z, w * fa, h * fa);
                            imgIndex++;
                            text(gajos[g].nombre, 15 * fa, x + Cimg.x, y + Cimg.y + 25 * fa, z + Cimg.z);
                        }
                    }
                }
            }
            ////circulo personas
            //for (var q = 0; q < 360; q += 4) {
            //    var Cini = VPolToCar({ x: 0, y: q, z: radio });
            //    geometry.vertices.push(Cini);
            //}

            var torus = new THREE.Line(geometry, lineMaterial);
            torus.position.x = x;
            torus.position.y = y;
            torus.position.z = z;
            scene.add(torus);
        }

        function text(s, size, x, y, z) {
            var font = getCache('fonts/helvetiker_regular.typeface.json.txt');
            if (font) {
                var shapes = font.generateShapes(s, size, 2);
                var geometry = new THREE.ShapeGeometry(shapes);
                var material = new THREE.MeshBasicMaterial({
                    color: "black",
                    transparent: true,
                    opacity: 0.8,
                    side: THREE.DoubleSide
                });
                geometry.computeBoundingBox();
                var bb = geometry.boundingBox;
                var text = new THREE.Mesh(geometry, material);
                text.position.x = x - (bb.max.x - bb.min.x) / 2;
                text.position.y = y;
                text.position.z = z;
                scene.add(text);
            }
        }

        function imgSize(src, x, y, z, w, h) {
            var image = getCache(src);
            var texture = new THREE.CanvasTexture(image);
            var material = new THREE.MeshBasicMaterial({ color: "transparent", map: texture, transparent: true, side: THREE.DoubleSide });
            var geometry = new THREE.PlaneGeometry(w, h);
            var mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(x, y, z);
            //mesh.rotation.set(90, 90, 180);
            scene.add(mesh);
        }

        function img(src, x, y, z) {
            var image = getCache(src);
            var texture = new THREE.CanvasTexture(image);
            var material = new THREE.MeshBasicMaterial({ color: "transparent", map: texture, transparent: true, side: THREE.DoubleSide });
            var geometry = new THREE.PlaneGeometry(image.width, image.height);
            var mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(x, y, z);
            //mesh.rotation.set(90, 90, 180);
            scene.add(mesh);
        }

        function getCache(id) {
            for (i in cache)
                if (cache[i].id == id)
                    return cache[i].res;
            return null;
        }

        function pushCache(id, res) {
            cache.push({ id: id, res: res });
        }

        function VAdd(v1, v2) {
            return new THREE.Vector3(v1.x + v2.x, v1.y + v2.y, v1.z + v2.z);
        }

        function VPolToCar(vector) {
            var ret = PolToCar(vector.x, vector.y, vector.z);
            return new THREE.Vector3(ret.x, ret.y, ret.z);
        }

        function VCarToPol(vector) {
            var ret = CarToPol(vector.x, vector.y, vector.z);
            return new THREE.Vector3(ret.x, ret.y, ret.z);
        }

        function PolToCar(lat, lon, radius) {
            var DEG2RAD = Math.PI / 180;
            var phi = (90 - lat) * DEG2RAD;
            var theta = (lon + 180) * DEG2RAD;

            return {
                x: -(radius * Math.sin(phi) * Math.sin(theta)),
                y: radius * Math.cos(phi),
                z: radius * Math.sin(phi) * Math.cos(theta),
            }
        }

        function CarToPol(x, y, z, radius) {
            var RAD2DEG = 180 / Math.PI;
            var lon = Math.atan2(x, -z) * RAD2DEG;
            var radius = Math.sqrt(x * x + z * z);
            var lat = Math.atan2(y, radius) * RAD2DEG;
            return { lon: lon, lat: lat, radius: radius };
        }

        function paint() {
            requestAnimationFrame(paint);
            renderer.render(scene, camera);
            controls.update();
            TWEEN.update();
        }

        function loadImg(src) {
            new THREE.ImageLoader()
                .setCrossOrigin('*')
                .load(src, function (image) {
                    pushCache(src, image);
                });
            //agregar [src + '?' + performance.now()] al load para asegurar que siempre cargue
        }

        function loadFont(src) {
            var loader = new THREE.FontLoader();
            loader.load(src, function (font) {
                pushCache(src, font);
            });
        }

        //personas
        function doPersonas(x, y, accion) {
            document.getElementById("todo").style.display = "inline";
            document.getElementById("canvasGL").style.display = "none";

            grupos = 0;
            usuarios = ";";
            representantes = ";";
            imgW = 17 * zoom; //imagen personita
            imgH = 42 * zoom; //imagen personita

            var centro = { x: x, y: y };
            return doPersonas2(bosque, centro, 0, accion);
        }

        function doPersonas2(nodo, centro, nivel, accion) {
            var s = '';

            if (nodo.exception) {
                var rect = toRect(centro.m, centro.a);
                s += msg(nodo.exception, centro)
            }
            else {
                //accion
                s += accion(nodo, centro, nivel);

                //hijos
                var hijoLeft = margen / 2 - nodo.ancho / 2;
                for (i in nodo.hijos) {
                    var hijo = nodo.hijos[i];
                    var hijoCentro = { x: centro.x + hijoLeft * zoom + hijo.ancho / 2 * zoom, y: centro.y + getHijoAltura(hijo) };

                    //hijo
                    s += doPersonas2(hijo, hijoCentro, nivel + 1, accion);
                    hijoLeft += hijo.ancho;

                    //lineas
                    if (!generando) {
                        s += "<line x1='" + (centro.x).toFixed(0) + "' y1='" + (centro.y + imgH + 30 * zoom).toFixed(0) + "' x2='" + (centro.x).toFixed(0) + "' y2='" + (centro.y + imgH + 50 * zoom).toFixed(0) + "' style='stroke:gray;stroke-width:2' />";
                        s += "<line x1='" + (centro.x).toFixed(0) + "' y1='" + (centro.y + imgH + 50 * zoom).toFixed(0) + "' x2='" + (hijoCentro.x).toFixed(0) + "' y2='" + (centro.y + imgH + 50 * zoom).toFixed(0) + "' style='stroke:gray;stroke-width:2' />";
                        s += "<line x1='" + (hijoCentro.x).toFixed(0) + "' y1='" + (centro.y + imgH + 50 * zoom).toFixed(0) + "' x2='" + (hijoCentro.x).toFixed(0) + "' y2='" + (hijoCentro.y + 4).toFixed(0) + "' style='stroke:gray;stroke-width:2' />";
                    }
                }
            }
            return s;
        }
          
        function getHijoAltura(nodo){
            return altura * zoom + imgH - nodo.horizontalidad / 100 * zoom * altura + 50 * zoom;
        }

        function doPersonasNodo(nodo, centro, nivel) {
            var s = "";

            grupos += 1;

            //verifico fallo de defincion de padre
            var url = nodo.URL + '/default.html?grupo=' + nodo.nombre;
            if (nodo.msg != "")
                s += msg(nodo.msg, centro);
            else if (!nodo.descargado) {
                s += msg("[?]", centro);
                generando = true;
            }
            else if (!nodo.padreVerificado)
                s += msg(nodo.nombre + " [" + tr("Grupo padre no corresponde") + "]", centro);
            else
                s += doPersonasNodoIconos(nodo.nombre, centro, url, nodo);
            return s;
        }

        function doPersonasNodoIconos(t1, centro, url, nodo) {
            var fontSize1 = 20 * zoom;
            if (fontSize1 > 20) fontSize1 = 20;
            var colorb = nodo.colorPromedio == 0 ? "transparent" : HTMLColor(nodo.colorPromedio);
            var own = nodo.nombre == usuario.grupo;

            var s = "<g transform='translate(" + centro.x.toFixed(0) + "," + centro.y.toFixed(0) + ")'>";

            //dibujo textos
            //nombre de grupo
            if (t1 != "" && fontSize1 > 8)
                s += "<text x='0' y='" + fontSize1.toFixed(0) + "' fill='gray' style='cursor:pointer;font-size:" + fontSize1.toFixed(0) + "px' text-anchor='middle' onClick=\"document.location='" + url + "'\">" + t1 + "</text>";

            //usuarios ordenados por rol (deben venir ordenados del servidor)
            var length = nodo.usuarios.length;
            for (var i in nodo.usuarios) {
                var usu = nodo.usuarios[i];
                s += "<image x='" + (-length * imgW / 2 + imgW * parseInt(i)) + "' y='" + (5 + fontSize1).toFixed(0) + "' height='" + (imgH).toFixed(0) + "px' width='" + (imgW) + "px'";
                s += " onmouseover='email=\"" + usu.email + "\";showInfo(\"" + usu.email + ";" + nodo.nombre + "\");' ";
                s += " style='cursor:pointer;' ";

                if (usu.email == email || email == "") {
                    if (usu.isRepresentante)
                        s += " xlink:href='res/representante.png'";
                    else if (usu.isAdmin)
                        s += " xlink:href='res/coordinador.png'";
                    else if (usu.isSecretaria)
                        s += " xlink:href='res/secretaria.png'";
                    else if (usu.isFacilitador)
                        s += " xlink:href='res/facilitador.png'";
                    else if (!usu.isActive)
                        s += " xlink:href='res/inactivo.png'";
                    else if (usu.readOnly)
                        s += " xlink:href='res/readonly.png'";
                    else
                        s += " xlink:href='res/activo.png'";
                }
                else if (email != "") 
                    s += " xlink:href='res/transparente.png'";
                s += "/>";

                //tu
                if (email == "" && usu.email == usuario.email) {
                    var iW = (19 * zoom).toFixed(0);
                    var iH = (17 * zoom).toFixed(0);
                    s += "<image x='" + (-length * imgW / 2 + imgW * parseInt(i)) + "' y='" + (5 + fontSize1 + imgH / 2 + 25 * zoom).toFixed(0) + "' height='" + iH + "px' width='" + iW + "px' xlink:href='res/aqui.png' />";
                }


                //acumulo lista de usuarios y representntes sin repticion
                if (usuarios.indexOf(";" + usu.email + ";") == -1)
                    usuarios += usu.email + ";";
                if (representantes.indexOf(";" + usu.email + ";") == -1 && usu.isRepresentante)
                    representantes += usu.email + ";";
            }
            s += "</g>";

            return s;
        }


        //grupos
        function doGrupos(x, y, radioInicial, accion) {
            document.getElementById("todo").style.display = "inline";
            document.getElementById("canvasGL").style.display = "none";

            grupos = 0;
            usuarios = ";";
            representantes = ";";

            var centro = toPolar(x, y);
            return doGrupos2(bosque, centro, radioInicial, 0, 360, 90, accion);
        }

        function doGrupos2(nodo, centro, radio, nivel, apertura, direccion, accion) {
            var s = '';

            if (nodo.exception) {
                var rect = toRect(centro.m, centro.a);
                s += msg(nodo.exception, centro)
            }
            else {
                if (radio > 5) {
                    //hijos
                    if (nodo.hijos.length > 0) {
                        var paso = apertura / nodo.hijos.length;
                        var hijoRadio;
                        if (nivel == 0)
                            hijoRadio = Math.PI * 2 * radio * 360 / apertura / nodo.hijos.length / 2 * 0.9; //radio - radio / niveles;
                        else
                            hijoRadio = Math.PI * 2 * radio / 2 * 180 / apertura / nodo.hijos.length / 2 * 0.9; //radio - radio / niveles;

                        if (hijoRadio > radio * 0.7)
                            hijoRadio = radio * 0.7;

                        for (i in nodo.hijos) {
                            var hijo = nodo.hijos[i];
                            var angulo = direccion - paso * (nodo.hijos.length - 1) / 2 + paso * i; //centrado en la direccion
                            var hijoCentro = addPolar(centro, { m: radio, a: angulo });
                            s += doGrupos2(hijo, hijoCentro, hijoRadio, nivel + 1, 180, angulo, accion);
                        }
                    }

                    //accion
                    s += accion(nodo, centro, radio, nivel);
                }
            }
            return s;
        }

        function doGrupoNodo(nodo, centro, radio) {
            var s = "";

            grupos += 1;
            nodo.id = grupos; //id dinamico en la estructura SVG
            nodo.torsion = 0;

            //cuento usuarios
            for (var i in nodo.usuarios) {
                var usu = nodo.usuarios[i];
                if (usuarios.indexOf(";" + usu.email + ";") == -1)
                    usuarios += usu.email + ";";
            }

            //verifico fallo de defincion de padre
            var url = nodo.URL + '/default.html?grupo=' + nodo.nombre;
            if (nodo.msg != "") 
                s += msg(nodo.msg, centro);
            else if (!nodo.descargado){ 
                s += msg("[?]", centro);
                generando = true;
            }
            else if (!nodo.padreVerificado)
                s += msg(nodo.nombre + " [" + tr("Grupo padre no corresponde") + "]", centro);
            else
                s += doGrupoNodoCirculo(nodo.nombre,
                    cut(nodo.objetivo, 25),
                    nodo.activos + "/" + nodo.usuarios.length + " " + tr("Activos"),
                    centro,
                    radio,
                    url,
                    nodo);
            return s;
        }

        function doGrupoNodoCirculo(t1, t2, t3, centro, r, url, nodo) {
            var rect = toRect(centro.m, centro.a);
            var x = rect.x;
            var y = rect.y;
            var fontSize1 = (4 + r / 5) * zoom;
            var fontSize2 = (4 + r / 5) * zoom - 8 * zoom;
            var fontSize3 = (4 + r / 5) * zoom - 16 * zoom;
            if (fontSize1 > 30) fontSize1 = 30;
            if (fontSize2 > 30 - 8) fontSize2 = 30 - 8;
            if (fontSize3 > 30 - 16) fontSize3 = 30 - 16;
            var colorb = nodo.colorPromedio == 0 ? "transparent" : HTMLColor(nodo.colorPromedio);
            var own = nodo.nombre == usuario.grupo;


            //var s = "<circle cx='" + x.toFixed(0) + "' cy='" + y.toFixed(0) + "' r='" + r.toFixed(0) + "' stroke='" + colorb + "' stroke-width='" + width + "' fill='" + colorb + "' fill-opacity='0.2' />";
            var s = "<g id='" + nodo.id + "' transform='translate(" + x.toFixed(0) + "," + y.toFixed(0) + ")'>";
            s += doGrupoNodoEngranaje(x, y, r, colorb, 1, nodo, url);

            if (r > 30) {
                //dibujo textos
                //nombre de grupo
                if (t1 != "" && fontSize1 > 8)
                    s += "<text x='0' y='" + (-fontSize1 / 2).toFixed(0) + "' fill='gray' style='cursor:pointer;font-size:" + fontSize1.toFixed(0) + "px' text-anchor='middle' onClick=\"document.location='" + url + "'\">" + t1 + "</text>";
                if (t2 != "" && fontSize2 > 8)
                    s += "<text x='0' y='" + (fontSize1 + 2).toFixed(0) + "' fill='gray' style='font-size:" + (fontSize2).toFixed(0) + "px' text-anchor='middle'>" + t2 + "</text>";
                if (t3 != "" && fontSize3 > 8)
                    s += "<text x='0' y='" + (fontSize1 + fontSize2 + 2).toFixed(0) + "' fill='gray' style='font-size:" + (fontSize3).toFixed(0) + "px' text-anchor='middle'>" + t3 + "</text>";
            }

            //own
            if (own) {
                s += "<image xlink:href='res/tu.png' x='-8' y='" + (-r - 10 * scale - 42 * scale) + "' height='" + (42 * scale) + "px' width='" + (17 * scale) + "px'/>";
                //s += "<circle cx='" + (r + 15).toFixed(0) + "' cy='0' r='10' stroke='" + colorb + "' stroke-width='3' fill='white' fill-opacity='1' />";
            }

            //centro
            s += "<circle cx='0' cy='0' r='5' stroke='" + colorb + "' stroke-width='1' fill='white' fill-opacity='0.6' />";

            s += "</g>";

            return s;
        }

        function doGrupoNodoEngranaje(x, y, r, colorb, width, nodo, url) {
            var s = "";
            //s += "<line x1='0' y1='0' x2='" + r.toFixed(0) + "' y2='0' stroke='" + colorb + "' stroke-width='" + width + "' fill='" + colorb + "' fill-opacity='0.2' />";
           
            //poligono
            //var lastp;
            //var points = "";
            //for (var a = 0; a < 361; a+= 360 / nodo.usuarios) {
            //    var p2 = toRect(r, a);
            //    if (lastp)
            //        points += p2.x.toFixed(0) + "," + p2.y.toFixed(0) + " ";

            //    lastp = { x: p2.x, y: p2.y };
            //}
            //s += "<polygon points='" + points + "' style='fill:" + colorb + ";stroke:gray;stroke-width:" + width + ";opacity:0.4' />";

            //engranaje
            var lastp;
            var points = "";
            for (var a = 0; a < 361; a+=0.5) {
                var p2 = toRect(diente(r, a), a);
                if (lastp)
                    points += p2.x.toFixed(0) + "," + p2.y.toFixed(0) + " ";
			
               lastp = { x: p2.x, y : p2.y};
            }
            s += "<polygon points='" + points + "' style='fill:" + colorb + ";stroke:black;stroke-width:" + width + ";opacity:0.4;cursor:pointer;' onClick=\"document.location='" + url + "'\"/>";

            //circulo
            //s += "<circle cx='0' cy='0' r='" + r.toFixed(0) + "' stroke='" + colorb + "' stroke-width='" + width + "' fill='" + colorb + "' fill-opacity='0.2' />";
            //var lastp;
            //for (var a = 0; a < nodo.usuarios; a++) {
            //    var p2 = toRect(r, a * r / 50);
            //    if (lastp) {
            //        s += "<circle cx='" + p2.x.toFixed(0) + "' cy='" + p2.y.toFixed(0) + "' r='5' stroke='" + colorb + "' stroke-width='" + width + "' fill='" + colorb + "' fill-opacity='0.2' />";
            //    }

            //    lastp = { x: p2.x, y: p2.y };
            //}

            return s;
        }

        function doTorsion() {
            //recorro el bosque
            if (bosque && ver == "grupos") {
                doGrupos(window.innerWidth / 2 + 10000, window.innerHeight / 2 + 10000, window.innerWidth / 8 * zoom, doTorsionNodo);
            }
        }

        function doTorsionNodo(nodo, centro, radio, nivel) {
            if (nodo.id && nodo.usuarios.length > 0) {
                var elem = document.getElementById(nodo.id);
                if (elem) {
                    var r = toRect(centro.m, centro.a);
                    elem.setAttribute('transform', "translate(" + r.x.toFixed(0) + "," + r.y.toFixed(0) + ") rotate(" + nodo.torsion + ")");
                    var step = nodo.activos / nodo.usuarios.length;
                    if (nivel % 2 == 1)
                        nodo.torsion += step;
                    else
                        nodo.torsion -= step;
                }
            }
            return "";
        }


        //tools
        function diente(r, a) {
            var sin = Math.sin(a * 2 * 3.1415 / 180 / (0.1));
            var rect;
            if (sin > 0) rect = 0; else rect = -10;
            return r + rect * r / 150;
        }

        function msg(s, centro) {
            var rect = toRect(centro.m, centro.a);
            var x = rect.x;
            var y = rect.y;
            var fontSize1 = 20 * zoom;
            s += "<text x='" + x.toFixed(0) + "' y='" + y.toFixed(0) + "' fill='gray' style='cursor:pointer;font-size:" + fontSize1.toFixed(0) + "px' text-anchor='middle' \">" + s + "</text>";
            return s;
        }
             
        function toPolar(x, y){
            var ret = { m: 0, a: 0 };
            ret.m = Math.sqrt(x * x + y * y);
            if (x == 0)
                if (y > 0) ret.a = 90; else ret.a = 270;
            else if (y == 0)
                if (x > 0) ret.a = 0; else ret.a = 180;
            else
            {
                if (y >= 0 && x >= 0) ret.a = Math.atan(y / x) * 180 / Math.PI;
                if (y >= 0 && x <= 0) ret.a = Math.atan(y / -x) * 180 / Math.PI + 90;
                if (y <= 0 && x <= 0) ret.a = Math.atan(y / x) * 180 / Math.PI + 180;
                if (y <= 0 && x >= 0) ret.a = Math.atan(-y / x) * 180 / Math.PI + 270;
            }
            return ret;
        }

        function doAtras() {
            document.location = "default.html?grupo=" + grupoParam;
        }
            
        function toRect(m, a)
        {
            //en grados
            return { x: Math.cos(a * Math.PI / 180) * m, y: Math.sin(a * Math.PI / 180) * m };
        }

        function cut(s, len) {
            if (s.length <= len)
                return s;
            else
                return s.substring(0, 25) + "...";
        }

        function getDimensiones(nodo, nivel) {
            //calculo profundiadd de la estructura y ancho por niveles
            var ret = 1;
            var maxHijo = 0;
            var hijosAncho = 0;
            var hijosAlto = 50;
            for (i in nodo.hijos) {
                var hijo = nodo.hijos[i];
                var dims = getDimensiones(hijo, nivel + 1);

                if (dims.niveles > maxHijo) 
                    maxHijo = dims.niveles;

                if (getHijoAltura(hijo) > hijosAlto)
                    hijosAlto = getHijoAltura(hijo);

                hijosAncho += hijo.ancho;
            }
            nodo.ancho = nodo.usuarios.length * imgW > hijosAncho ? nodo.usuarios.length * imgW : hijosAncho;
            nodo.ancho = nodo.nombre.length * 11 > nodo.ancho ? nodo.nombre.length * 11 : nodo.ancho;  //nombre de grupo largo
            nodo.ancho += margen; //margen
            return { niveles: ret + maxHijo, ancho: nodo.ancho, alto: hijosAlto + getHijoAltura(nodo) };
        }

        function addPolar(p1, p2) {
            var r1 = toRect(p1.m, p1.a);
            var r2 = toRect(p2.m, p2.a);
            return toPolar(r1.x + r2.x, r1.y + r2.y);
        }

        function showInfo(clave) {
            var grupo = clave.split(";")[1];
            var email = clave.split(";")[0];
            var div = document.getElementById("info");
            div.innerHTML = "";
            showInfo2(bosque, grupo, email);

            if (cleanInterval != null) clearInterval(cleanInterval);
            cleanInterval = setTimeout(mostrarTodo, 5000); //para que vuelva a enseñar a todas las personas
            dibujarTodo();
        }

        function mostrarTodo() {
            email = "";
            dibujarTodo();
            cleanInterval = null;
        }

        function showInfo2(nodo, grupo, email) {
            //colores
            //coordinador   #0066CC
            //secretaria    #FF66CC
            //representante #00CC99
            //facilitador   #FF9900

            if (!nodo.exception) {
                //accion
                if (nodo.nombre == grupo) {
                    for (var i in nodo.usuarios) {
                        var usu = nodo.usuarios[i];
                        if (usu.email == email) {
                            var div = document.getElementById("info");
                            var info = "<span>" + nodo.nombre + "</span><br>"
                            info += "<b>" + usu.nombre + "</b><br>";
                            info += "<b>" + usu.funcion + "</b><br>";
                            info += "<a href='mailto:" + usu.email + "'>" + usu.email + "</a><br>";
                            info += usu.readOnly ? "Solo lectura<br>" : "";
                            info += usu.isActive ? "Activo<br>" : "Inactivo<br>";
                            info += usu.isSecretaria ? "<span style='color:#FF66CC'>Secretaria</span><br>" : "";
                            info += usu.isFacilitador ? "<span style='color:#FF9900'>Facilitador</span><br>" : "";
                            info += usu.isRepresentante ? "<span style='color:#00CC99'>Representante</span><br>" : "";
                            info += usu.isAdmin ? "<span style='color:#0066CC'>Coordinador</span><br>" : "";
                            info += "Desde:" + usu.grupoDesde + "<br>";
                            info += "Nacido:" + formatDate(jsonToDate(usu.born)) + "<br>";

                            div.innerHTML = info;
                            div.style.visibility = "visible";
                        }
                    }
                }
                else {
                    //hijos
                    for (i in nodo.hijos) {
                        var hijo = nodo.hijos[i];
                        showInfo2(hijo, grupo, email);
                    }
                }
            }
        }
    </script>
</head>
<body onload="doLoad();" style="overflow:hidden">
    <canvas id="canvasGL" style="left:0px;top:0px;width:100%;height:100%;z-index:-1"></canvas>
    <svg id="todo" style="position: absolute;left:0px;top:0px;width:100%;height:100%;z-index:-1"></svg>

    <!--atras--------------------------------------------------------------------------------------------------->
    <img id="atras" title="Atras" src="res/atras.png"  class="atras" onclick="doAtras();" />

    <!--titulo--------------------------------------------------------------------------------------------------->
    <div id="titulo" class="tituloPagina"></div>       
    <div id="msg" style="position:fixed;left:5vw;top:10vh;float:left;"></div>
    
    <div style="position:fixed;left:0.5vw;top:10vh;">
    <!--panel grupo--------------------------------------------------------------------------------------------------->
    <div id="panelGrupo" class="borde" style="visibility:hidden; padding: 5px; margin-top: 25px; margin-top:1vh; color: gray;">
    </div>
    <!--panel info--------------------------------------------------------------------------------------------------->
    <div id="info"  class="borde titulo3" style="visibility:hidden; padding: 5px; margin-top:5px; color: gray;overflow: auto;">
    </div>
    </div>

    <!--joystick--------------------------------------------------------------------------------------------------->
    <div id="joystick" style="position:fixed;bottom: 5px;padding: 5px;left:5px; ">
        <nobr>
            <img src="res/jzm.png" onclick="zoom *= 1.1; dibujarTodo();" class="img" />
            <img src="res/ju.png" onclick="offsetY -= 30; dibujarTodo();" class="img" />
        </nobr>
        <br />
        <nobr>
            <img src="res/jl.png" onclick="offsetX -= 30; dibujarTodo();" class="img" />
            <img src="res/j00.png" onclick="zoom = 1; transform(0,0); dibujarTodo();" class="img" />
            <img src="res/jr.png" onclick="offsetX += 30; dibujarTodo();" class="img" />
        </nobr>
        <br />
        <nobr>
            <img src="res/jzl.png" onclick="zoom *= 0.9; dibujarTodo();" class="img" />
            <img src="res/jd.png" onclick="offsetY += 30; dibujarTodo();" class="img" />
        </nobr>
    </div>

    <!--rotarpantalla--------------------------------------------------------------------------------------------------->
        <div id="rotarpantalla" class="rotarpantalla">
            <img src="res/rotarpantalla.png" style="margin: 0 auto;padding:50px;" />
            <img src="res/logo.png" style="margin: 0 auto;padding:50px;" />
        </div>

</body>
</html>